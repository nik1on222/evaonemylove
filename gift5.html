<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>–ò—Å—Ç–æ—Ä–∏—è –Ω–∞—Å –¥–≤–æ–∏—Ö ‚Äî –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–∞—è –º–∞–Ω–≥–∞</title>
  <style>
    :root{--bg:#0f1724;--card:#0b1220;--accent:#ff6b6b;--muted:#94a3b8;--glass:rgba(255,255,255,0.03)}
    *{box-sizing:border-box}
    body{font-family:Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; margin:0; background:linear-gradient(180deg,#071025 0%, #071b2a 100%); color:#e6eef8; display:flex; align-items:center; justify-content:center; min-height:100vh; padding:24px; overflow-x:hidden}
    .app{width:100%; max-width:920px; display: none;} /* –°–∫—Ä—ã–≤–∞–µ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é */

    /* –°—Ç–∏–ª–∏ –¥–ª—è —ç–∫—Ä–∞–Ω–∞ –ø–∞—Ä–æ–ª—è */
    .password-screen {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: linear-gradient(135deg, #071025 0%, #1a2b3c 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      transition: opacity 0.5s ease;
    }

    .password-container {
      background: var(--card);
      border-radius: 16px;
      padding: 32px;
      width: 90%;
      max-width: 400px;
      text-align: center;
      box-shadow: 0 12px 40px rgba(2, 6, 23, 0.8);
      border: 1px solid rgba(255, 255, 255, 0.05);
    }

    .password-logo {
      width: 80px;
      height: 80px;
      border-radius: 16px;
      background: linear-gradient(135deg, var(--accent), #ff9b6b);
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 auto 20px;
      font-weight: 700;
      font-size: 28px;
      color: #081124;
      box-shadow: 0 0 25px rgba(255, 107, 107, 0.5);
    }

    .password-title {
      margin: 0 0 10px;
      font-size: 22px;
    }

    .password-subtitle {
      color: var(--muted);
      margin-bottom: 25px;
      font-size: 14px;
    }

    .password-input {
      width: 100%;
      padding: 14px 16px;
      border-radius: 10px;
      background: rgba(255, 255, 255, 0.03);
      border: 1px solid rgba(255, 255, 255, 0.1);
      color: #e6eef8;
      font-size: 16px;
      margin-bottom: 20px;
      transition: all 0.2s;
    }

    .password-input:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 2px rgba(255, 107, 107, 0.2);
    }

    .password-error {
      color: #ff6b6b;
      font-size: 14px;
      margin-top: 10px;
      min-height: 20px;
      opacity: 0;
      transition: opacity 0.3s;
    }

    .password-error.show {
      opacity: 1;
    }

    .password-btn {
      background: linear-gradient(90deg, var(--accent), #ff9b6b);
      color: #081124;
      border: none;
      padding: 12px 24px;
      border-radius: 10px;
      font-weight: 600;
      font-size: 16px;
      cursor: pointer;
      transition: all 0.2s;
      width: 100%;
    }

    .password-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 15px rgba(255, 107, 107, 0.3);
    }

    /* –û—Å—Ç–∞–ª—å–Ω—ã–µ —Å—Ç–∏–ª–∏ –æ—Å—Ç–∞—é—Ç—Å—è –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π */
    header{display:flex; align-items:center; gap:16px; margin-bottom:18px}
    .logo{width:72px; height:72px; border-radius:10px; background:linear-gradient(135deg,var(--accent),#ff9b6b); display:flex; align-items:center; justify-content:center; font-weight:700; color:#081124; box-shadow:0 0 20px rgba(255,107,107,0.4)}
    h1{margin:0; font-size:20px}
    .card{background:var(--card); border-radius:14px; padding:18px; box-shadow:0 6px 30px rgba(2,6,23,0.6)}
    .stage{display:grid; grid-template-columns:1fr 360px; gap:18px}
    .viewer{background:var(--glass); border-radius:12px; padding:16px; min-height:560px; display:flex; flex-direction:column; position:relative; overflow:hidden}
    .page{flex:1; display:flex; flex-direction:column; align-items:center; justify-content:flex-start; text-align:left; padding:10px; opacity:0; transform:translateY(18px); transition:all .45s ease}
    .page.show{opacity:1; transform:translateY(0)}
    .page img{max-width:100%; max-height:220px; border-radius:8px; box-shadow:0 8px 30px rgba(2,6,23,0.6); margin-bottom:12px}

    /* Messenger/dialogue styles */
    .dialogue{display:flex; flex-direction:column; gap:10px; width:100%; max-width:760px; margin-top:10px}
    .bubble{padding:10px 14px; border-radius:14px; max-width:75%; position:relative; word-wrap:break-word; opacity:0; transform:translateY(8px); transition:all .28s ease; box-shadow:0 6px 18px rgba(2,6,23,0.4)}
    .bubble.me{align-self:flex-end; background:linear-gradient(90deg,var(--accent),#ff9b6b); color:#081124; border-bottom-right-radius:6px}
    .bubble.eva{align-self:flex-start; background:rgba(255,255,255,0.03); color:#e6eef8; border-bottom-left-radius:6px}
    .bubble.show{opacity:1; transform:translateY(0)}
    .bubble .speaker{font-size:12px; opacity:.75; margin-bottom:6px}

    .controls{display:flex; gap:8px; margin-top:12px; justify-content:center}
    button{background:#0b2540;border:1px solid rgba(255,255,255,0.03); color:#e6eef8; padding:10px 12px; border-radius:8px; cursor:pointer; transition:all .18s}
    button:hover{transform:translateY(-2px)}
    button.primary{background:linear-gradient(90deg,var(--accent),#ff9b6b); color:#081124; font-weight:600}
    .sidebar{background:linear-gradient(180deg, rgba(255,255,255,0.02), transparent); border-radius:10px; padding:12px}
    h2{margin:6px 0 12px}
    .chapter-list{display:flex; flex-direction:column; gap:8px; max-height:320px; overflow:auto}
    .chapter{padding:8px; border-radius:8px; cursor:pointer; background:transparent; display:flex; justify-content:space-between; align-items:center; transition:all .12s}
    .chapter:hover{background:rgba(255,255,255,0.03)}
    .chapter.disabled{opacity:.5; cursor:not-allowed}
    .chapter.active{background:rgba(255,255,255,0.06); border:1px solid rgba(255,255,255,0.04)}
    .tasks{margin-top:12px}
    .task{display:flex; gap:8px; align-items:flex-start; margin-bottom:8px}
    .task input{transform:scale(1.15)}
    .final{display:none; padding:18px; border-radius:10px; text-align:center; animation:fadeIn 1s forwards}
    .final.show{display:block}
    .flower{width:200px; height:200px; margin:0 auto; animation:grow 1.6s ease forwards}
    footer{margin-top:12px; display:flex; justify-content:space-between; align-items:center; color:var(--muted); font-size:13px}
    .progress-bar{height:8px; background:rgba(255,255,255,0.07); border-radius:4px; margin-top:12px; overflow:hidden}
    .progress{height:100%; width:0; background:linear-gradient(90deg,var(--accent),#ff9b6b); transition:width .35s}
    @media (max-width:880px){.stage{grid-template-columns:1fr;}.sidebar{order:2}}
    @keyframes fadeIn{from{opacity:0}to{opacity:1}}
    @keyframes grow{from{transform:scale(0.6);opacity:0}to{transform:scale(1);opacity:1}}

    .modal{position:fixed; top:0; left:0; width:100%; height:100%; background:linear-gradient(rgba(3,6,12,0.6), rgba(3,6,12,0.6)); display:flex; align-items:center; justify-content:center; opacity:0; pointer-events:none; transition:opacity .3s}
    .modal.show{opacity:1; pointer-events:auto}
    .modal-content{background:linear-gradient(180deg,var(--card), rgba(11,17,32,0.9)); padding:20px; border-radius:14px; max-width:520px; text-align:center; box-shadow:0 12px 40px rgba(2,6,23,0.7); border:1px solid rgba(255,255,255,0.03)}
    .modal-icon{font-size:36px; margin-bottom:8px}
    .modal-content h3{margin:6px 0 6px; color:var(--accent)}
    .modal-content p{color:var(--muted); margin:0}
    .modal-actions{display:flex; gap:10px; justify-content:center; margin-top:14px}
    .btn-ghost{background:transparent; border:1px solid rgba(255,255,255,0.06); color:var(--muted); padding:8px 12px; border-radius:8px}
  </style>
</head>
<body>
  <!-- –≠–∫—Ä–∞–Ω –≤–≤–æ–¥–∞ –ø–∞—Ä–æ–ª—è -->
  <div class="password-screen" id="passwordScreen">
    <div class="password-container">
      <div class="password-logo">MN</div>
      <h2 class="password-title">–î–æ—Å—Ç—É–ø –∫ –∏—Å—Ç–æ—Ä–∏–∏</h2>
      <p class="password-subtitle">–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–æ–π –º–∞–Ω–≥–∏</p>
      <input type="password" class="password-input" id="passwordInput" placeholder="–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å" />
      <div class="password-error" id="passwordError">–ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞.</div>
      <button class="password-btn" id="passwordBtn">–û—Ç–∫—Ä—ã—Ç—å –∏—Å—Ç–æ—Ä–∏—é</button>
    </div>
  </div>

  <!-- –û—Å–Ω–æ–≤–Ω–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ (–∏–∑–Ω–∞—á–∞–ª—å–Ω–æ —Å–∫—Ä—ã—Ç–æ) -->
  <div class="app" id="app">
    <header>
      <div class="logo">MN</div>
      <div>
        <h1>¬´–ò—Å—Ç–æ—Ä–∏—è –Ω–∞—Å –¥–≤–æ–∏—Ö¬ª ‚Äî –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–∞—è –º–∞–Ω–≥–∞</h1>
        <div style="color:var(--muted); font-size:13px">–ö–ª–∏–∫–∞–π –ø–æ –≥–ª–∞–≤–∞–º, –≤—ã–ø–æ–ª–Ω—è–π –∑–∞–¥–∞–Ω–∏—è –∏ –æ–±—â–∞–π—Å—è –∫–∞–∫ –≤ –º–µ—Å—Å–µ–Ω–¥–∂–µ—Ä–µ</div>
      </div>
    </header>

    <div class="card">
      <div class="stage">
        <div class="viewer" id="viewer">
          <div class="page" id="page" aria-live="polite"></div>

          <div class="controls" id="controls">
            <button id="prevBtn">‚óÄ –ù–∞–∑–∞–¥</button>
            <button id="nextBtn" class="primary">–í–ø–µ—Ä—ë–¥ ‚ñ∂</button>
          </div>

          <div class="progress-bar" aria-hidden="true"><div id="progress" class="progress"></div></div>
        </div>

        <aside class="sidebar">
          <h2>–ì–ª–∞–≤—ã</h2>
          <div class="chapter-list" id="chapters" role="navigation" aria-label="–°–ø–∏—Å–æ–∫ –≥–ª–∞–≤"></div>

          <div class="tasks" id="tasks">
            <h3 style="margin:8px 0 8px">–ó–∞–¥–∞–Ω–∏—è</h3>
            <div id="taskList"></div>
          </div>

          <div class="final" id="final" aria-hidden="true">
            <h3>–ù–∞–≥—Ä–∞–¥–∞</h3>
            <p>–¢—ã –ø—Ä–æ—à–ª–∞ –≤—Å–µ –∏—Å–ø—ã—Ç–∞–Ω–∏—è ‚Äî –æ—Ç–∫—Ä–æ–π —Ñ–∏–Ω–∞–ª—å–Ω—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É –∏ –ø–æ–ª—É—á–∏ –Ω–∞–≥—Ä–∞–¥—É –≤ —Ä–µ–∞–ª—å–Ω–æ—Å—Ç–∏.</p>
            <div class="flower" id="flowerSVG" aria-hidden="true"></div>
            <p style="margin-top:8px">üåπ –ë—É–∫–µ—Ç –∂–¥—ë—Ç —Ç–µ–±—è</p>
            <button id="claimBtn" class="primary">–Ø –≥–æ—Ç–æ–≤(–∞) –ø—Ä–∏–Ω—è—Ç—å –ø–æ–¥–∞—Ä–æ–∫</button>
          </div>
        </aside>
      </div>

      <footer>
        <div>–°–¥–µ–ª–∞–Ω–æ —Å ‚ù§Ô∏è ‚Äî –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤ –¥–ª—è –≤–∞—à–µ–π –ø–∞—Ä—ã</div>
        <div style="color:var(--muted)">–ü–æ–¥—Å–∫–∞–∑–∫–∞: –≤—ã–ø–æ–ª–Ω—è–π—Ç–µ –∑–∞–¥–∞–Ω–∏—è —Ç–æ–ª—å–∫–æ –ø–æ —Å–æ–≥–ª–∞—Å–∏—é</div>
      </footer>
    </div>
  </div>

  <div class="modal" id="modal" role="dialog" aria-modal="true" aria-hidden="true">
    <div class="modal-content">
      <div class="modal-icon" id="modalIcon">üí°</div>
      <h3 id="modalTitle">–ù–µ —Å–ø–µ—à–∏</h3>
      <p id="modalText">–°–Ω–∞—á–∞–ª–∞ –≤—ã–ø–æ–ª–Ω–∏ –≤—Å–µ –∑–∞–¥–∞–Ω–∏—è —ç—Ç–æ–π –≥–ª–∞–≤—ã, –∞ –ø–æ—Ç–æ–º –ø–µ—Ä–µ—Ö–æ–¥–∏ –¥–∞–ª—å—à–µ.</p>
      <div class="modal-actions">
        <button id="modalClose" class="primary">–ü–æ–Ω—è–ª(–∞)</button>
        <button id="modalShowTasks" class="btn-ghost">–ü–æ–∫–∞–∑–∞—Ç—å –∑–∞–¥–∞–Ω–∏—è</button>
      </div>
    </div>
  </div>

  <script>
    // === –ü–ê–†–û–õ–¨ –î–û–°–¢–£–ü–ê ===
    const CORRECT_PASSWORD = "StoryOfLove";
    const passwordScreen = document.getElementById('passwordScreen');
    const passwordInput = document.getElementById('passwordInput');
    const passwordBtn = document.getElementById('passwordBtn');
    const passwordError = document.getElementById('passwordError');
    const app = document.getElementById('app');

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –±—ã–ª –ª–∏ —É–∂–µ –≤–≤–µ–¥–µ–Ω –ø–∞—Ä–æ–ª—å –≤ —ç—Ç–æ–π —Å–µ—Å—Å–∏–∏
    const isAuthenticated = sessionStorage.getItem('authenticated') === 'true';

    if (isAuthenticated) {
      // –ï—Å–ª–∏ —É–∂–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω, —Å–∫—Ä—ã–≤–∞–µ–º —ç–∫—Ä–∞–Ω –ø–∞—Ä–æ–ª—è –∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
      passwordScreen.style.display = 'none';
      app.style.display = 'block';
    }

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –Ω–∞–∂–∞—Ç–∏—è –Ω–∞ –∫–Ω–æ–ø–∫—É –≤—Ö–æ–¥–∞
    passwordBtn.addEventListener('click', checkPassword);

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –Ω–∞–∂–∞—Ç–∏—è Enter –≤ –ø–æ–ª–µ –ø–∞—Ä–æ–ª—è
    passwordInput.addEventListener('keypress', function(e) {
      if (e.key === 'Enter') {
        checkPassword();
      }
    });

    function checkPassword() {
      if (passwordInput.value === CORRECT_PASSWORD) {
        // –ü—Ä–∞–≤–∏–ª—å–Ω—ã–π –ø–∞—Ä–æ–ª—å
        sessionStorage.setItem('authenticated', 'true');
        passwordScreen.style.opacity = '0';
        setTimeout(() => {
          passwordScreen.style.display = 'none';
          app.style.display = 'block';
        }, 500);
      } else {
        // –ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å
        passwordError.classList.add('show');
        passwordInput.value = '';
        setTimeout(() => {
          passwordError.classList.remove('show');
        }, 3000);
      }
    }

    // === DATA: 9 –≥–ª–∞–≤ (9-—è —Ñ–∏–Ω–∞–ª—å–Ω–∞—è ‚Äî –∏–≥—Ä–∞ –ø–æ —Å—Ü–µ–Ω–µ) ===
    const chapters = [
      {id:0, title:'–ì–ª–∞–≤–∞ 1 ‚Äî –ü–µ—Ä–≤–∞—è –≤—Å—Ç—Ä–µ—á–∞', img:placeholderSVG('–í—Å—Ç—Ä–µ—á–∞ —É –ø–æ–¥—ä–µ–∑–¥–∞, —á–∞–π –∏ –±–∏—Å–∫–≤–∏—Ç'), dialogue:[
        {speaker:'–ù–∏–∫–∏—Ç–∞', text:'–ú—ã —Ç–æ–≥–¥–∞ —Ç–æ–ª—å–∫–æ –ø–æ —Ç–≥ –æ–±—â–∞–ª–∏—Å—å, –∏ –≤–æ—Ç —è —Ä–µ—à–∏–ª—Å—è –ø—Ä–∏–µ—Ö–∞—Ç—å –∫ —Ç–µ–±–µ —Å –ø–∞—á–∫–æ–π –±–∏—Å–∫–≤–∏—Ç–∞ –∏ —á–∞–µ–º.'},
        {speaker:'–ï–≤–∞', text:'–ê—Ö–∞—Ö–∞, —è —Ä–µ–∞–ª—å–Ω–æ –≤—ã—à–ª–∞ –∫–∞–∫ –±–æ–º–∂–∏–∫ –≤ –¥–æ–º–∞—à–Ω–∏—Ö —à–º–æ—Ç–∫–∞—Ö –∏ –≤ —à–ª—ë–ø–∫–∞—Ö.'},
        {speaker:'–ù–∏–∫–∏—Ç–∞', text:'–¢—ã —Ö–æ—Ç–µ–ª–∞ –º–µ–Ω—è –æ–±–Ω—è—Ç—å ‚Äî –∏ —è —Å–Ω–∞—á–∞–ª–∞ –Ω–µ–º–Ω–æ–≥–æ –∑–∞—Å—Ç–µ—Å–Ω—è–ª—Å—è, –ø–æ–º–Ω—è, —á—Ç–æ —Ç—ã –Ω–µ –æ—á–µ–Ω—å –ª—é–±–∏—à—å —Ç–∞–∫—Ç–∏–ª—å–Ω–æ—Å—Ç—å.'},
        {speaker:'–ï–≤–∞', text:'–ù–æ —Ç—ã –≤—Å—ë —Ä–∞–≤–Ω–æ –æ–±–Ω—è–ª. –Ø —ç—Ç–æ –∑–∞–ø–æ–º–Ω–∏–ª–∞.'},
        {speaker:'–ù–∏–∫–∏—Ç–∞', text:'–Ø –ø–æ—Ç–æ–º —É–±–µ–∂–∞–ª, –∫–∞–∫ –¥—É—Ä–∞–∫, –Ω–æ —ç—Ç–æ—Ç –º–æ–º–µ–Ω—Ç —Å—Ç–∞–ª –Ω–∞—á–∞–ª–æ–º.'}
      ], tasks:[{text:'–í—Å–ø–æ–º–Ω–∏ –∏ —Ä–∞—Å—Å–∫–∞–∂–∏, —á—Ç–æ —Ç—ã –ø–æ—á—É–≤—Å—Ç–≤–æ–≤–∞–ª–∞ –≤ —Ç–æ—Ç –º–æ–º–µ–Ω—Ç', type:'text'}]},

      {id:1, title:'–ì–ª–∞–≤–∞ 2 ‚Äî –ü–µ—Ä–≤—ã–µ —Ä—É–∫–∏', img:placeholderSVG('–ü—Ä–æ–≥—É–ª–∫–∞ –ø–æ —Ç—Ä–∞—Å—Å–µ'), dialogue:[
        {speaker:'–ù–∏–∫–∏—Ç–∞', text:'–ú—ã —Ç–æ–≥–¥–∞ –ø—Ä–æ—Å—Ç–æ —à–ª–∏ –ø–æ —Ç—Ä–∞—Å—Å–µ, –Ω–∏–∫–∞–∫–æ–π —Ä–æ–º–∞–Ω—Ç–∏–∫–∏, –ª–∏—à—å –¥–æ—Ä–æ–≥–∞ –∏ —Ä–∞–∑–≥–æ–≤–æ—Ä—ã.'},
        {speaker:'–ï–≤–∞', text:'–ù–æ –∏–º–µ–Ω–Ω–æ —Ç–∞–º –º—ã –≤–ø–µ—Ä–≤—ã–µ –≤–∑—è–ª–∏—Å—å –∑–∞ —Ä—É–∫–∏... –∏ —ç—Ç–æ –±—ã–ª–æ —Ç–∞–∫–æ–µ –æ—â—É—â–µ–Ω–∏–µ.'},
        {speaker:'–ù–∏–∫–∏—Ç–∞', text:'–Ø —Ç–∞–∫ –≤–æ–ª–Ω–æ–≤–∞–ª—Å—è, —Ä–µ–∞–ª—å–Ω–æ, —Å–µ—Ä–¥—Ü–µ –±–∏–ª–æ—Å—å –ø–∏–∑–¥–µ—Ü –±—ã—Å—Ç—Ä–æ, —Ä—É–∫–∏ –ø–æ—Ç–µ–ª–∏ ‚Äî –∑–∞–ø–æ–º–Ω–∏–ª —ç—Ç–æ—Ç –º–æ–º–µ–Ω—Ç –Ω–∞ –≤—Å—é –∂–∏–∑–Ω—å.'},
        {speaker:'–ï–≤–∞', text:'–Ø —Ç–æ–∂–µ –≤–æ–ª–Ω–æ–≤–∞–ª–∞—Å—å. –ù–æ –º–Ω–µ –±—ã–ª–æ —Ç–µ–ø–ª–æ –∏ —Å–ø–æ–∫–æ–π–Ω–æ —Ä—è–¥–æ–º —Å —Ç–æ–±–æ–π.'},
        {speaker:'–ù–∏–∫–∏—Ç–∞', text:'–î–∞, —è –±–æ—è–ª—Å—è –≤—Å—ë –∏—Å–ø–æ—Ä—Ç–∏—Ç—å, –Ω–æ –Ω–∞–º –ø–æ–≤–µ–∑–ª–æ.'}
      ], tasks:[{text:'–û–ø–∏—à–∏, —á—Ç–æ —Ç—ã —Ç–æ–≥–¥–∞ —á—É–≤—Å—Ç–≤–æ–≤–∞–ª–∞, –∫–æ–≥–¥–∞ –º—ã –≤–∑—è–ª–∏—Å—å –∑–∞ —Ä—É–∫–∏', type:'text'}]},

      {id:2, title:'–ì–ª–∞–≤–∞ 3 ‚Äî –ü–µ—Ä–≤—ã–π –ø–æ—Ü–µ–ª—É–π', img:placeholderSVG('–ü–æ—Ü–µ–ª—É–π —É –¥–≤–æ—Ä–∞ –¥–æ–º–∞'), dialogue:[
        {speaker:'–ù–∏–∫–∏—Ç–∞', text:'–≠—Ç–æ –±—ã–ª–æ —É —Ç–µ–±—è –≤–æ –¥–≤–æ—Ä–µ: —Ç—ã —Å—Ö–≤–∞—Ç–∏–ª–∞ –º–µ–Ω—è –∑–∞ —à–µ—é, –∏ –º–∏—Ä –Ω–∞ —Å–µ–∫—É–Ω–¥—É –æ—Å—Ç–∞–Ω–æ–≤–∏–ª—Å—è.'},
        {speaker:'–ï–≤–∞', text:'–ò —É —Ç–µ–±—è –¥–∞–∂–µ –±—É—Ç—ã–ª–∫–∞ –∫–æ–ª—ã –≤—ã–ø–∞–ª–∞ –∏–∑ —Ä—É–∫ ‚Äî —è —á—É—Ç—å –Ω–µ —Ä–∞—Å–ø–ª–∞–∫–∞–ª–∞—Å—å –æ—Ç —Å–º–µ—Ö–∞.'},
        {speaker:'–ù–∏–∫–∏—Ç–∞', text:'–≠—Ç–æ –±—ã–ª –º–æ–π –ø–µ—Ä–≤—ã–π –ø–æ—Ü–µ–ª—É–π. –Ø –±–µ–∑—É–º–Ω–æ —Å—á–∞—Å—Ç–ª–∏–≤, —á—Ç–æ –æ–Ω –±—ã–ª —Å —Ç–æ–±–æ–π.'},
        {speaker:'–ï–≤–∞', text:'–ê —è —Ä–∞–¥–∞, —á—Ç–æ —Å–º–æ–≥–ª–∞ –ø–æ–¥–∞—Ä–∏—Ç—å —Ç–µ–±–µ —ç—Ç–æ—Ç –º–æ–º–µ–Ω—Ç.'}
      ], tasks:[{text:'–í—Å–ø–æ–º–Ω–∏ –∏ –ø–æ–≤—Ç–æ—Ä–∏ –∞—Ç–º–æ—Å—Ñ–µ—Ä—É —Ç–æ–≥–æ –ø–æ—Ü–µ–ª—É—è (–≤ –º—ã—Å–ª—è—Ö –∏–ª–∏ –≤—Å–ª—É—Ö)', type:'action'}]},

      {id:3, title:'–ì–ª–∞–≤–∞ 4 ‚Äî –ó–Ω–∞–∫–æ–º—Å—Ç–≤–æ —Å —Ä–æ–¥–∏—Ç–µ–ª—è–º–∏', img:placeholderSVG('–í–µ—á–µ—Ä —É —Ä–æ–¥–∏—Ç–µ–ª–µ–π'), dialogue:[
        {speaker:'–ï–≤–∞', text:'–°–ø–∞—Å–∏–±–æ, —á—Ç–æ –ø—Ä–∏—à—ë–ª –ø–æ–∑–Ω–∞–∫–æ–º–∏—Ç—å—Å—è —Å –º–æ–∏–º–∏ —Ä–æ–¥–∏—Ç–µ–ª—è–º–∏ ‚Äî –º–Ω–µ —ç—Ç–æ –±—ã–ª–æ –æ—á–µ–Ω—å –Ω—É–∂–Ω–æ.'},
        {speaker:'–ù–∏–∫–∏—Ç–∞', text:'–î–ª—è —Ç–µ–±—è —è –≥–æ—Ç–æ–≤ –Ω–∞ –º–Ω–æ–≥–æ–µ. –¢—ã –º–æ—ë –≤—Å—ë.'},
        {speaker:'–ï–≤–∞', text:'–Ø —Ç–∞–∫ –±–æ—è–ª–∞—Å—å, –∫–∞–∫ –æ–Ω–∏ —Ç–µ–±—è –ø—Ä–∏–º—É—Ç, –∞ —Ç—ã –±—ã–ª —Ç–∞–∫–∏–º –∑–∞–±–æ—Ç–ª–∏–≤—ã–º.'},
        {speaker:'–ù–∏–∫–∏—Ç–∞', text:'–ú—ã –≤—ã–¥–µ—Ä–∂–∞–ª–∏ —ç—Ç–æ –≤–º–µ—Å—Ç–µ ‚Äî –∏ —ç—Ç–æ –Ω–∞—Å —Ç–æ–ª—å–∫–æ —Å–±–ª–∏–∑–∏–ª–æ.'}
      ], tasks:[{text:'–†–∞—Å—Å–∫–∞–∂–∏, —á—Ç–æ –æ—Å–æ–±–µ–Ω–Ω–æ –∑–∞–ø–æ–º–Ω–∏–ª–æ—Å—å –≤ —Ç–æ–º –∑–Ω–∞–∫–æ–º—Å—Ç–≤–µ', type:'text'}]},

      {id:4, title:'–ì–ª–∞–≤–∞ 5 ‚Äî –ü–µ—Ä–≤–∞—è "—Ç–∞—Ä–µ–ª–æ—á–∫–∞"', img:placeholderSVG('–¢–∏—Ö–∏–π –≤–µ—á–µ—Ä –¥–æ–º–∞'), dialogue:[
        {speaker:'–ù–∏–∫–∏—Ç–∞', text:'–ú—ã —à—É—Ç–∏–ª–∏ –ø—Ä–æ "–ø–æ–º—ã—Ç—å –ø–æ—Å—É–¥—É" ‚Äî –∏ –ø—Ä–∞–Ω—á–∏–ª–∏, –Ω–∞–∑—ã–≤–∞—è —ç—Ç–æ "—Ç–∞—Ä–µ–ª–æ—á–∫–æ–π". –Ø —Ç–∞–∫ –ø–æ–¥—à—É—á–∏–≤–∞–ª: \"–≤—ã–ª–µ–∑–∞–π, –≤—ã–ª–∏–∑—ã–≤–∞–π –ø–æ—Å—É–¥—É\".'},
        {speaker:'–ï–≤–∞', text:'–Ø —Ç–æ–≥–¥–∞ –æ—á–µ–Ω—å –±–æ—è–ª–∞—Å—å, —á—Ç–æ –ø–æ—Å–ª–µ —ç—Ç–æ–≥–æ —Ç—ã –∑–∞—Ö–æ—á–µ—à—å –±–æ–ª—å—à–µ–≥–æ –∏ –≤—Å—ë –ø–æ–π–¥—ë—Ç –Ω–µ —Ç–∞–∫.'},
        {speaker:'–ù–∏–∫–∏—Ç–∞', text:'–ù–æ —è –ø—Ä–æ—Å—Ç–æ –≤—Å—Ç–∞–ª, –≤—ã—à–µ–ª, –ø—Ä–∏–Ω–µ—Å —Ç–µ–±–µ –≤–æ–¥—ã –∏ —Ü–µ–ª—ã–π –¥–µ–Ω—å –±—ã–ª —Ä—è–¥–æ–º. –Ø —Ö–æ—Ç–µ–ª, —á—Ç–æ–±—ã —Ç—ã —á—É–≤—Å—Ç–≤–æ–≤–∞–ª–∞ —Å–µ–±—è —Å–ø–æ–∫–æ–π–Ω–æ.'},
        {speaker:'–ï–≤–∞', text:'–≠—Ç–æ –±—ã–ª–æ –¥–ª—è –º–µ–Ω—è –∑–Ω–∞—á–∏–º–æ ‚Äî –Ω–µ –¥–∞–≤–ª–µ–Ω–∏–µ, –∞ –∑–∞–±–æ—Ç–∞. –°–ø–∞—Å–∏–±–æ.'}
      ], tasks:[{text:'–ü–æ–¥–µ–ª–∏—Å—å, –∫–∞–∫ —Ç—ã —Ç–æ–≥–¥–∞ –≤–æ—Å–ø—Ä–∏–Ω—è–ª–∞ –º–æ—é –∑–∞–±–æ—Ç—É (–≤ –º—ã—Å–ª—è—Ö –∏–ª–∏ –≤ —Å–æ–æ–±—â–µ–Ω–∏–∏)', type:'text'}]},

      {id:5, title:'–ì–ª–∞–≤–∞ 6 ‚Äî –î–µ–Ω—å —Ä–æ–∂–¥–µ–Ω–∏—è (–≥–æ—Ç–æ–≤–∏–ª –ø–æ–¥–∞—Ä–æ–∫)', img:placeholderSVG('–ü–æ–∏—Å–∫ –ø–æ–¥–∞—Ä–∫–∞ –∏ —ç–∫–æ–Ω–æ–º–∏—è'), dialogue:[
        {speaker:'–ù–∏–∫–∏—Ç–∞', text:'–Ø –¥–æ–ª–≥–æ –∫–æ–ø–∏–ª –Ω–∞ –ø–æ–¥–∞—Ä–æ–∫ ‚Äî –±—É–∫–≤–∞–ª—å–Ω–æ —Å–æ–±–∏—Ä–∞–ª –¥–µ–Ω—å–≥–∏ –ø–æ –º–µ–ª–æ—á–∏ –∏ –ø–ª–∞—Ç–∏–ª –∑–∞ –≤—Å—ë, –∫–æ–≥–¥–∞ –º–æ–≥.'},
        {speaker:'–ï–≤–∞', text:'–Ø –ø–æ–º–Ω—é, —É —Ç–µ–±—è –±—ã–ª–æ —Ç—è–∂–µ–ª–æ ‚Äî —Ç—ã –ø–ª–∞—Ç–∏–ª –∑–∞ –Ω–∞—Å, —Ö–æ—Ç—è —Å–∞–º —ç–∫–æ–Ω–æ–º–∏–ª –Ω–∞ –ø—Ä–æ—Å—Ç—ã—Ö –≤–µ—â–∞—Ö.'},
        {speaker:'–ù–∏–∫–∏—Ç–∞', text:'–≠—Ç–æ –±—ã–ª–æ —Å–ª–æ–∂–Ω–æ, —è –¥–∞–∂–µ –Ω–µ –¥–µ—Ä–∂–∞–ª —ç—Ç–∏ –¥–µ–Ω—å–≥–∏ –≤ —Ä—É–∫–∞—Ö, –Ω–æ —Å–¥–µ–ª–∞–ª –≤—Å—ë, —á—Ç–æ–±—ã –Ω–∞–∫–æ–ø–∏—Ç—å –∏ –≤—ã–±—Ä–∞—Ç—å —á—Ç–æ-—Ç–æ –≤–∞–∂–Ω–æ–µ.'},
        {speaker:'–ï–≤–∞', text:'–ò —Ç—ã —Å–¥–µ–ª–∞–ª —ç—Ç–æ. –Ø –¥–æ —Å–∏—Ö –ø–æ—Ä –Ω–µ –≤–µ—Ä—é, –∫–∞–∫ —Ç—ã –≤—Å—ë –æ—Ä–≥–∞–Ω–∏–∑–æ–≤–∞–ª.'}
      ], tasks:[{text:'–ù–∞–ø–∏—à–∏, –∑–∞ —á—Ç–æ —Ç—ã —Ü–µ–Ω–∏—à—å –º–æ–∏ —Å—Ç–∞—Ä–∞–Ω–∏—è –≤ —Ç–æ—Ç –ø–µ—Ä–∏–æ–¥', type:'text'}]},

      {id:6, title:'–ì–ª–∞–≤–∞ 7 ‚Äî –î–µ–Ω—å —Ä–æ–∂–¥–µ–Ω–∏—è (–≤–µ—á–µ—Ä–æ–º)', img:placeholderSVG('–í–µ—á–µ—Ä —Å –¥—Ä—É–∑—å—è–º–∏ –∏ —É–µ–¥–∏–Ω–µ–Ω–∏–µ'), dialogue:[
        {speaker:'–ù–∏–∫–∏—Ç–∞', text:'–Ø –ø—Ä–∏—à—ë–ª –ø–æ–º–æ–≥–∞—Ç—å —Å —Å–∞–ª–∞—Ç–∞–º–∏, –≥–æ—Ç–æ–≤–∏–ª –∫–∞–∫ –º–æ–≥ ‚Äî –æ—á–µ–Ω—å –¥–µ—Ä–µ–≤—è–Ω–Ω–æ, –Ω–æ —Å –¥—É—à–æ–π.'},
        {speaker:'–ï–≤–∞', text:'–ú—ã –≤—Å–µ —Å–º–µ—è–ª–∏—Å—å: —Ç—ã —Å–º–µ—à–Ω–æ —Ä–µ–∑–∞–ª –æ–≥—É—Ä—Ü—ã, –Ω–æ –±—ã–ª —Ä—è–¥–æ–º.'},
        {speaker:'–ù–∏–∫–∏—Ç–∞', text:'–ü–æ—Å–ª–µ –≤–µ—á–µ—Ä–∞, –∫–æ–≥–¥–∞ –≤—Å–µ –Ω–µ–º–Ω–æ–≥–æ –Ω–∞–±—É—Ö–∞–ª–∏, –º—ã —É–µ–¥–∏–Ω–∏–ª–∏—Å—å ‚Äî –ª–∞—Å–∫–∞–ª–∏ –¥—Ä—É–≥ –¥—Ä—É–≥–∞, –æ–±—Å—É–∂–¥–∞–ª–∏ –ø–æ–¥–∞—Ä–∫–∏ –∏ –ø—Ä–æ—Å—Ç–æ –±—ã–ª–∏ —Ä—è–¥–æ–º.'},
        {speaker:'–ï–≤–∞', text:'–≠—Ç–æ –±—ã–ª–∞ —Ç—ë–ø–ª–∞—è –Ω–æ—á—å: –∏ —Å–∞–ª–∞—Ç—ã, –∏ —Å–º–µ—Ö, –∏ —Ç–µ–ø–ª–æ –ø–æ–¥ –ø–ª–µ–¥–æ–º.'}
      ], tasks:[{text:'–í—Å–ø–æ–º–Ω–∏ —Ç–æ—Ç –≤–µ—á–µ—Ä: —á—Ç–æ —Ç–µ–±–µ –±—ã–ª–æ –≤–∞–∂–Ω–æ —Ç–æ–≥–¥–∞ (–Ω–µ —Ç–æ—Ä–æ–ø–∏—Å—å)', type:'text'}]},

      {id:7, title:'–ì–ª–∞–≤–∞ 8 ‚Äî –ì–æ–¥ –≤–º–µ—Å—Ç–µ', img:placeholderSVG('–ì–æ–¥–æ–≤—â–∏–Ω–∞ –∏ –ø–æ–¥–∞—Ä–æ–∫'), dialogue:[
        {speaker:'–ù–∏–∫–∏—Ç–∞', text:'–ü—Ä–æ—à—ë–ª –≥–æ–¥ ‚Äî —Å–∞–º—ã–π —Ä–æ–º–∞–Ω—Ç–∏—á–Ω—ã–π –≥–æ–¥ –≤ –º–æ–µ–π –∂–∏–∑–Ω–∏. –ú—ã –ø—Ä–æ—à–ª–∏ –º–Ω–æ–≥–æ–µ.'},
        {speaker:'–ï–≤–∞', text:'–°–ø–∞—Å–∏–±–æ, —á—Ç–æ –±—ã–ª —Å–æ –º–Ω–æ–π –≤ —Ç—Ä—É–¥–Ω—ã–µ –º–æ–º–µ–Ω—Ç—ã –∏ —Ä–∞–¥–æ—Å—Ç–Ω—ã–µ —Ç–æ–∂–µ.'},
        {speaker:'–ù–∏–∫–∏—Ç–∞', text:'–í–æ—Ç —Ç–≤–æ–π –º–∞–ª–µ–Ω—å–∫–∏–π –ø–æ–¥–∞—Ä–æ–∫ ‚Äî –∑–Ω–∞–∫ —Ç–æ–≥–æ, —á—Ç–æ —è —Ü–µ–Ω—é –∫–∞–∂–¥—ã–π –º–æ–º–µ–Ω—Ç —Å —Ç–æ–±–æ–π.'},
        {speaker:'–ï–≤–∞', text:'–Ø —Ç–∞–∫ —Ç—Ä–æ–Ω—É—Ç–∞. –≠—Ç–æ—Ç –≥–æ–¥ –±—ã–ª –Ω–∞—à–∏–º.'}
      ], tasks:[{text:'–ù–∞–ø–∏—à–∏ –ø–æ–∑–¥—Ä–∞–≤–ª–µ–Ω–∏–µ –∏ –ø–æ–∂–µ–ª–∞–Ω–∏–µ –Ω–∞ —Å–ª–µ–¥—É—é—â–∏–π –≥–æ–¥ –≤–º–µ—Å—Ç–µ', type:'text'}]},

      {id:8, title:'–ì–ª–∞–≤–∞ 9 ‚Äî –ò–≥—Ä–∞ (—Å—Ü–µ–Ω–∞ –∏–∑ "–ö–ª—É–± —Ä–æ–º–∞–Ω—Ç–∏–∫–∏")', img:placeholderSVG('–ò–≥—Ä–æ–≤–∞—è —Å—Ü–µ–Ω–∞ –∏ —Å–æ–≥–ª–∞—Å–∏–µ'), dialogue:[
        {speaker:'–ù–∏–∫–∏—Ç–∞', text:'–°–ª—É—à–∞–π, –¥–∞–≤–∞–π —Å—ã–≥—Ä–∞–µ–º –≤ –æ–¥–Ω—É –∏–≥—Ä—É: —Ç—ã –≤—ã–±–∏—Ä–∞–µ—à—å –ª—é–±—É—é —Å—Ü–µ–Ω—É –∏–∑ —Ç–≤–æ–µ–π –º–∞–Ω–≥–∏ "–ö–ª—É–± —Ä–æ–º–∞–Ω—Ç–∏–∫–∏" ‚Äî –º—ã –µ—ë –ø—Ä–æ–∏–≥—Ä—ã–≤–∞–µ–º, —á–µ—Å—Ç–Ω–æ –∏ –ø–æ —Å–æ–≥–ª–∞—Å–∏—é.'},
        {speaker:'–ï–≤–∞', text:'–≠—Ç–æ... –∑–≤—É—á–∏—Ç –¥–µ—Ä–∑–∫–æ. –ù–æ –µ—Å–ª–∏ —ç—Ç–æ —Ç–æ, —á–µ–≥–æ —è —Ö–æ—á—É, –∏ –µ—Å–ª–∏ –º—ã –æ–±–∞ —Å–æ–≥–ª–∞—Å–Ω—ã ‚Äî –¥–∞.'},
        {speaker:'–ù–∏–∫–∏—Ç–∞', text:'–ú—ã –∑–∞—Ä–∞–Ω–µ–µ –æ–±–≥–æ–≤–æ—Ä–∏–º –≥—Ä–∞–Ω–∏—Ü—ã. –ì–ª–∞–≤–Ω–æ–µ ‚Äî –≤–∑–∞–∏–º–Ω–æ–µ —Å–æ–≥–ª–∞—Å–∏–µ –∏ –∫–æ–º—Ñ–æ—Ä—Ç.'},
        {speaker:'–ï–≤–∞', text:'–•–æ—Ä–æ—à–æ. –Ø –¥–æ–≤–µ—Ä—è—é —Ç–µ–±–µ. –ò –ø–æ—Ç–æ–º ‚Äî —Ç–≤–æ–π –ø–æ–¥–∞—Ä–æ–∫.'},
        {speaker:'–ù–∏–∫–∏—Ç–∞', text:'–î–∞, –ø–æ—Å–ª–µ —Ç–æ–≥–æ, –∫–∞–∫ —Ç—ã –æ—Ç–∫—Ä–æ–µ—à—å—Å—å ‚Äî —É –º–µ–Ω—è –µ—Å—Ç—å —Å—é—Ä–ø—Ä–∏–∑ –¥–ª—è —Ç–µ–±—è.'}
      ], tasks:[{text:'–û–±—Å—É–¥–∏—Ç–µ –∏ –∑–∞–ø–∏—à–∏—Ç–µ –≤–∞—à–∏ –≥—Ä–∞–Ω–∏—Ü—ã –∏ —Å–æ–≥–ª–∞—Å–∏—è –ø–µ—Ä–µ–¥ –∏–≥—Ä–æ–π', type:'text'}]}
    ];

    // === state & storage ===
    let current = Number(localStorage.getItem('currentChapter') || 0);
    let done = JSON.parse(localStorage.getItem('doneTasks') || '{}');

    function ensureDoneStructure(){
      chapters.forEach(ch=>{
        if(!Array.isArray(done[ch.id])) done[ch.id] = new Array(ch.tasks.length).fill(false);
        if(done[ch.id].length !== ch.tasks.length){
          const arr = done[ch.id] || [];
          const newArr = arr.slice(0, ch.tasks.length).concat(new Array(Math.max(0, ch.tasks.length - arr.length)).fill(false));
          done[ch.id] = newArr;
        }
      });
      saveDone();
    }
    function saveDone(){ localStorage.setItem('doneTasks', JSON.stringify(done)); }
    function saveCurrent(){ localStorage.setItem('currentChapter', String(current)); }

    // === elements ===
    const chaptersEl = document.getElementById('chapters');
    const pageEl = document.getElementById('page');
    const taskListEl = document.getElementById('taskList');
    const finalEl = document.getElementById('final');
    const progressEl = document.getElementById('progress');
    const modal = document.getElementById('modal');
    const modalTitle = document.getElementById('modalTitle');
    const modalText = document.getElementById('modalText');
    const modalIcon = document.getElementById('modalIcon');
    const modalClose = document.getElementById('modalClose');
    const modalShowTasks = document.getElementById('modalShowTasks');
    const claimBtn = document.getElementById('claimBtn');
    const prevBtn = document.getElementById('prevBtn');
    const nextBtn = document.getElementById('nextBtn');
    const controls = document.getElementById('controls');

    modalClose.addEventListener('click', hideModal);
    modalShowTasks.addEventListener('click', ()=>{ hideModal(); scrollToTasks(); });

    function showModal(title, text, icon='üí°'){
      modalTitle.textContent = title || '–ù–µ —Å–ø–µ—à–∏';
      modalText.textContent = text || '–°–Ω–∞—á–∞–ª–∞ –≤—ã–ø–æ–ª–Ω–∏ –≤—Å–µ –∑–∞–¥–∞–Ω–∏—è —ç—Ç–æ–π –≥–ª–∞–≤—ã, –∞ –ø–æ—Ç–æ–º –ø–µ—Ä–µ—Ö–æ–¥–∏ –¥–∞–ª—å—à–µ.';
      modalIcon.textContent = icon;
      modal.classList.add('show');
      modal.setAttribute('aria-hidden', 'false');
    }
    function hideModal(){ modal.classList.remove('show'); modal.setAttribute('aria-hidden', 'true'); }

    function scrollToTasks(){
      const tasksBlock = document.getElementById('tasks');
      if(tasksBlock) tasksBlock.scrollIntoView({behavior:'smooth', block:'center'});
    }

    // === render functions ===
    function renderChapters(){
      chaptersEl.innerHTML = '';
      chapters.forEach(ch=>{
        const el = document.createElement('div');
        const isActive = ch.id === current;
        el.className = 'chapter' + (isActive? ' active':'');
        const blocked = ch.id > current && !allTasksDoneForChapter(current);
        if(blocked) el.classList.add('disabled');

        el.innerHTML = `<div>${escapeHtml(ch.title)}</div><div style="color:var(--muted); font-size:13px">${ch.tasks.length} –∑–∞–¥–∞–Ω–∏–µ(–π)</div>`;
        el.addEventListener('click', ()=>{
          if(ch.id > current && !allTasksDoneForChapter(current)){
            showModal('–°–Ω–∞—á–∞–ª–∞ –∑–∞–¥–∞–Ω–∏—è', '–í—ã–ø–æ–ª–Ω–∏ –∑–∞–¥–∞–Ω–∏—è —Ç–µ–∫—É—â–µ–π –≥–ª–∞–≤—ã, —á—Ç–æ–±—ã –æ—Ç–∫—Ä—ã—Ç—å —Å–ª–µ–¥—É—é—â—É—é.', '‚ö†Ô∏è');
            return;
          }
          current = ch.id;
          saveCurrent();
          render();
        });
        chaptersEl.appendChild(el);
      });
    }

    let revealTimeouts = [];
    function clearRevealTimeouts(){ revealTimeouts.forEach(id=>clearTimeout(id)); revealTimeouts = []; }

    function renderPage(){
      const ch = chapters[current];
      pageEl.setAttribute('aria-label', ch.title);
      pageEl.classList.remove('show');
      clearRevealTimeouts();
      setTimeout(()=>{
        let html = `<div style="max-width:760px;margin:0 auto">${ch.img}<h2 style="margin:12px 0 12px">${escapeHtml(ch.title)}</h2><div class="dialogue">`;
        ch.dialogue.forEach((d, idx)=>{
          const who = d.speaker === '–ù–∏–∫–∏—Ç–∞' ? 'me' : 'eva';
          html += `<div class="bubble ${who}" data-idx="${idx}" aria-hidden="true"><div class="speaker">${escapeHtml(d.speaker)}</div><div class="bubble-text">${escapeHtml(d.text)}</div></div>`;
        });
        html += `</div></div>`;
        pageEl.innerHTML = html;
        pageEl.classList.add('show');

        // reveal bubbles sequentially
        const bubbles = Array.from(pageEl.querySelectorAll('.bubble'));
        bubbles.forEach((b, i)=>{
          const t = setTimeout(()=>{ b.classList.add('show'); b.setAttribute('aria-hidden','false'); }, 220 * i);
          revealTimeouts.push(t);
          b.addEventListener('click', revealAll);
        });
      },80);

      // Hide "next" if last chapter (end of story)
      const lastIndex = chapters.length - 1;
      if(current >= lastIndex){
        nextBtn.style.display = 'none';
      } else {
        nextBtn.style.display = '';
      }
    }

    function revealAll(){
      clearRevealTimeouts();
      const bubbles = Array.from(pageEl.querySelectorAll('.bubble'));
      bubbles.forEach(b=>{ b.classList.add('show'); b.setAttribute('aria-hidden','false'); });
    }

    function renderTasks(){
      const ch = chapters[current];
      taskListEl.innerHTML = '';
      done[ch.id] = done[ch.id] || new Array(ch.tasks.length).fill(false);

      ch.tasks.forEach((t,i)=>{
        const div = document.createElement('div');
        div.className='task';
        const id = `task-${ch.id}-${i}`;
        let extra = '';
        if(t.type === 'private') extra = '<div style="font-size:12px;color:var(--muted);margin-left:auto">–ü—Ä–∏–≤–∞—Ç–Ω–æ</div>';

        div.innerHTML = `
          <input type="checkbox" id="${id}" ${done[ch.id][i]? 'checked':''} />
          <label for="${id}">${escapeHtml(t.text)}</label>
          ${extra}
        `;
        taskListEl.appendChild(div);

        const input = document.getElementById(id);
        input.addEventListener('change', (e)=>{
          done[ch.id][i] = e.target.checked;
          saveDone();
          checkAllDone();
          updateProgress();
          renderChapters();
        });
      });
    }

    function allTasksDoneForChapter(chId){
      return Array.isArray(done[chId]) && done[chId].length > 0 && done[chId].every(Boolean);
    }

    function checkAllDone(){
      const all = chapters.every(ch=> allTasksDoneForChapter(ch.id));
      if(all){ finalEl.classList.add('show'); finalEl.setAttribute('aria-hidden','false'); }
      else{ finalEl.classList.remove('show'); finalEl.setAttribute('aria-hidden','true'); }
    }

    function updateProgress(){
      const totalTasks = chapters.reduce((a,ch)=>a+ch.tasks.length,0);
      const doneTasks = Object.keys(done).reduce((acc,k)=> acc + (Array.isArray(done[k]) ? done[k].filter(Boolean).length : 0), 0);
      const percent = totalTasks === 0 ? 0 : Math.round((doneTasks/totalTasks)*100);
      progressEl.style.width = percent + '%';
    }

    function renderFlower(){
      const el = document.getElementById('flowerSVG');
      if(!el) return;
      el.innerHTML = `
        <svg viewBox="0 0 120 120" xmlns="http://www.w3.org/2000/svg">
          <g transform="translate(60,40)">
            <g>
              <circle r="10" fill="#ff9b9b" />
              <circle r="6" fill="#ff6b6b" />
            </g>
            <g transform="rotate(45)">
              <ellipse rx="14" ry="6" fill="#ff9b9b" />
            </g>
            <g transform="rotate(90)">
              <ellipse rx="14" ry="6" fill="#ff9b9b" />
            </g>
            <g transform="rotate(135)">
              <ellipse rx="14" ry="6" fill="#ff9b9b" />
            </g>
            <g transform="translate(-10,28)">
              <rect x="0" y="0" width="8" height="36" rx="4" fill="#5d8a5d" transform="rotate(-10)" />
              <rect x="8" y="0" width="8" height="36" rx="4" fill="#4f7a4f" transform="rotate(10)" />
            </g>
          </g>
        </svg>
      `;
    }

    function render(){
      ensureDoneStructure();
      renderChapters();
      renderPage();
      renderTasks();
      renderFlower();
      checkAllDone();
      updateProgress();
    }

    // === controls ===
    prevBtn.addEventListener('click', ()=>{
      if(current>0){ current--; saveCurrent(); render(); }
    });

    nextBtn.addEventListener('click', ()=>{
      if(!allTasksDoneForChapter(current)){
        showModal('–ù–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ', '–ß—Ç–æ–±—ã –ø–µ—Ä–µ–π—Ç–∏ –¥–∞–ª—å—à–µ ‚Äî —Å–Ω–∞—á–∞–ª–∞ –æ—Ç–º–µ—Ç—å –∑–∞–¥–∞–Ω–∏—è —ç—Ç–æ–π –≥–ª–∞–≤—ã –∫–∞–∫ –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ.', '‚ö†Ô∏è');
        return;
      }
      if(current < chapters.length - 1){ current++; saveCurrent(); render(); }
    });

    claimBtn.addEventListener('click', ()=>{
      showModal('–ü–æ–∑–¥—Ä–∞–≤–ª—è–µ–º!', '–¢—ã –ø—Ä–æ—à–ª–∞ –≤—Å–µ –∑–∞–¥–∞–Ω–∏—è ‚Äî –¥–æ–≥–æ–≤–æ—Ä–∏—Ç–µ—Å—å –æ –≤—Ä—É—á–µ–Ω–∏–∏ –±—É–∫–µ—Ç–∞.', 'üéÅ');
    });

    // === helpers ===
    function placeholderSVG(text){
      const escaped = escapeHtml(text);
      return `
        <svg width="100%" height="220" viewBox="0 0 900 220" xmlns="http://www.w3.org/2000/svg" style="border-radius:8px; background:linear-gradient(90deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));">
          <defs>
            <linearGradient id="g1" x1="0" x2="1"><stop offset="0" stop-color="#0b2233"/><stop offset="1" stop-color="#082b40"/></linearGradient>
          </defs>
          <rect width="900" height="220" fill="url(#g1)" rx="12"/>
          <text x="50%" y="50%" dominant-baseline="middle" text-anchor="middle" font-family="sans-serif" font-size="28" fill="#9fb3c8">${escaped}</text>
        </svg>
      `;
    }

    function escapeHtml(str){
      return String(str || '').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
    }

    // Accessibility: close modal on Escape
    document.addEventListener('keydown', (e)=>{ if(e.key === 'Escape') hideModal(); });

    // initial render (—Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω)
    if (isAuthenticated) {
      render();
    }
  </script>
</body>
</html>